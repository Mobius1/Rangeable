/*!
 *
 * Rangeable
 * Copyright (c) 2018 Karl Saunders (mobius1(at)gmx(dot)com)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 * Version: 0.1.1
 *
 */
(function(i,j){"object"==typeof exports?module.exports=j("Rangeable"):"function"==typeof define&&define.amd?define([],j):i.Rangeable=j("Rangeable")})("undefined"==typeof global?this.window||this.global:global,function(){var version="0.1.1";var i=function(p,q){var r=document.createElement(p);return q&&r.classList.add(q),r},j=function(p){return p&&"function"==typeof p},n=function(p,q,r){var s;return function(){if(r=r||this,!s)return p.apply(r,arguments),s=!0,setTimeout(function(){s=!1},q)}},o=function(p,q){this.plugins=["ruler"],"string"==typeof p&&(p=document.querySelector(p)),this.input=p,this.config=Object.assign({},{type:"single",tooltips:"always",updateThrottle:30,classes:{input:"rangeable-input",container:"rangeable-container",vertical:"rangeable-vertical",progress:"rangeable-progress",handle:"rangeable-handle",tooltip:"rangeable-tooltip",track:"rangeable-track",multiple:"rangeable-multiple",disabled:"rangeable-disabled"}},q),this.mouseAxis={x:"clientX",y:"clientY"},this.trackSize={x:"width",y:"height"},this.trackPos={x:"left",y:"top"},this.lastPos=0,this.double="double"===this.config.type||Array.isArray(this.config.value),this.touch="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,this.init(),this.onInit()};return o.prototype.init=function(){if(!this.input.rangeable){var q,p={min:0,max:100,step:1,value:this.input.value};for(q in p)this.input[q]||(this.input[q]=p[q]),void 0!==this.config[q]&&(this.input[q]=this.config[q]);this.axis=this.config.vertical?"y":"x",this.input.rangeable=this,this.double?(this.input.values=this.config.value?this.config.value:[this.input.min,this.input.max],this.input.defaultValues=this.input.values.slice()):this.input.defaultValue||(this.input.defaultValue=this.input.value),this.render(),this.initialised=!0}},o.prototype.render=function(){var p=this,q=this.config,r=q.classes,s=i("div",r.container),t=i("div",r.track),u=i("div",r.progress),v=i("div",r.handle),w=i("div",r.tooltip);if(this.input.tabIndex=-1,this.double?(v=[i("div",r.handle),i("div",r.handle)],w=[i("div",r.tooltip),i("div",r.tooltip),i("div",r.tooltip)],v.forEach(function(y,z){y.index=z,u.appendChild(y),y.appendChild(w[z]),y.tabIndex=1,q.handles&&q.handles[z]&&q.handles[z].locked&&!0===q.handles[z].locked&&(y.locked=!0)}),q.vertical&&u.appendChild(v[0]),u.appendChild(w[2]),s.classList.add(r.multiple)):(u.appendChild(v),v.appendChild(w),v.tabIndex=1,q.handle&&q.handle.locked&&!0===q.handle.locked&&(v.locked=!0)),s.appendChild(t),q.vertical&&s.classList.add(r.vertical),q.size&&(s.style[this.trackSize[this.axis]]=isNaN(q.size)?q.size:q.size+"px"),q.tooltips&&(s.classList.add("has-tooltip"),"string"==typeof q.tooltips&&"always"===q.tooltips&&s.classList.add("show-tooltip")),this.nodes={container:s,track:t,progress:u,handle:v,tooltip:w},!this.double)q.handle&&void 0!==q.handle.min&&void 0!==q.handle.max&&(v=i("div","rangeable-buffer"),t.appendChild(v),this.nodes.buffer=v,this.limits={min:q.handle.min,max:q.handle.max});else if(q.handles){this.nodes.buffers=[],this.limits=[];var x=i("div","rangeable-buffers");q.handles.forEach(function(y,z){if(void 0!==y.min&&void 0!==y.max){var A=i("div","rangeable-buffer");x.appendChild(A),p.nodes.buffers.push(A),p.limits[z]={min:y.min,max:y.max}}}),t.appendChild(x)}t.appendChild(u),this.input.parentNode.insertBefore(s,this.input),s.insertBefore(this.input,t),this.input.classList.add(r.input),this.bind(),this.update()},o.prototype.reset=function(){this.double?this.input.defaultValues.forEach(this.setValue,this):this.setValue(this.input.defaultValue),this.onEnd()},o.prototype.setValueFromPosition=function(p){var q=parseFloat(this.input.min),r=parseFloat(this.input.max),s=parseFloat(this.input.step),t=this.touch?p.touches[0][this.mouseAxis[this.axis]]:p[this.mouseAxis[this.axis]],u=t-this.rects.container[this.trackPos[this.axis]],v=this.rects.container[this.trackSize[this.axis]];return"mousedown"===p.type&&(!this.double&&this.nodes.handle.contains(p.target)||this.double&&(this.nodes.handle[0].contains(p.target)||this.nodes.handle[1].contains(p.target)))?!1:(p=Math.ceil(((this.config.vertical?100*((v-u)/v):100*(u/v))*(r-q)/100+q)/s)*s,t>=this.lastPos&&(p-=s),parseFloat(p)!==parseFloat(this.startValue)&&void(s=!1,this.double&&(s=this.activeHandle.index),p=this.limit(p,s),this.setValue(p,s)))},o.prototype.start=function(p){return p.preventDefault(),this.startValue=this.getValue(),this.onStart(),this.nodes.container.classList.add("dragging"),this.recalculate(),this.activeHandle=this.getHandle(p),!!this.activeHandle&&void(this.activeHandle.classList.add("active"),this.setValueFromPosition(p),this.touch?(document.addEventListener("touchmove",this.events.move,!1),document.addEventListener("touchend",this.events.stop,!1),document.addEventListener("touchcancel",this.events.stop,!1)):(document.addEventListener("mousemove",this.events.move,!1),document.addEventListener("mouseup",this.events.stop,!1)))},o.prototype.move=function(p){this.setValueFromPosition(p),this.lastPos=this.touch?p.touches[0][this.mouseAxis[this.axis]]:p[this.mouseAxis[this.axis]]},o.prototype.stop=function(){this.stopValue=this.getValue(),this.nodes.container.classList.remove("dragging"),this.onEnd(),this.activeHandle.classList.remove("active"),this.activeHandle=!1,this.touch?(document.removeEventListener("touchmove",this.events.move),document.removeEventListener("touchend",this.events.stop),document.removeEventListener("touchcancel",this.events.stop)):(document.removeEventListener("mousemove",this.events.move),document.removeEventListener("mouseup",this.events.stop)),this.startValue!==this.stopValue&&this.input.dispatchEvent(new Event("change")),this.startValue=null},o.prototype.keydown=function(p){var q=this,r=function(s){switch(p.key){case"ArrowRight":case"ArrowUp":q.stepUp(s);break;case"ArrowLeft":case"ArrowDown":q.stepDown(s);}};this.double?this.nodes.handle.forEach(function(s){s===document.activeElement&&r(s.index)}):this.nodes.handle===document.activeElement&&r()},o.prototype.stepUp=function(p){var q=parseFloat(this.input.step),r=this.getValue();this.double&&void 0!==p&&(r=r[p]),q=this.limit(parseFloat(r)+q,p),this.setValue(q,p)},o.prototype.stepDown=function(p){var q=parseFloat(this.input.step),r=this.getValue();this.double&&void 0!==p&&(r=r[p]),q=this.limit(parseFloat(r)-q,p),this.setValue(q,p)},o.prototype.limit=function(p,q){var r=this.input,s=parseFloat(r.min),t=parseFloat(r.max);return this.double&&void 0!==q?(!q&&p>r.values[1]?p=r.values[1]:q&&p<r.values[0]&&(p=r.values[0]),this.limits)&&(q?p>this.limits[1].max?p=this.limits[1].max:p<this.limits[1].min&&(p=this.limits[1].min):p>this.limits[0].max?p=this.limits[0].max:p<this.limits[0].min&&(p=this.limits[0].min)):this.limits&&(p>this.limits.max?p=this.limits.max:p<this.limits.min&&(p=this.limits.min)),p>t?p=t:p<s&&(p=s),p},o.prototype.recalculate=function(){var p=[];this.double?this.nodes.handle.forEach(function(q,r){p[r]=q.getBoundingClientRect()}):p=this.nodes.handle.getBoundingClientRect(),this.rects={handle:p,container:this.nodes.container.getBoundingClientRect()}},o.prototype.update=function(){var p=this;this.recalculate(),this.accuracy=0,this.input.step.includes(".")&&(this.accuracy=(this.input.step.split(".")[1]||[]).length);var q=this.getValue(),r=this.rects.container[this.trackSize[this.axis]],s=function(t,u,v){t.style[p.config.vertical?"bottom":"left"]=u+"px",t.style[p.trackSize[p.axis]]=v/p.input.max*r-u+"px"};this.double?(this.config.handles&&this.nodes.buffers&&this.config.handles.forEach(function(t,u){s(p.nodes.buffers[u],t.min/p.input.max*r,t.max)}),this.input.values.forEach(function(t,u){p.setValue(p.limit(t,u),u)})):(this.config.handle&&s(this.nodes.buffer,this.config.handle.min/this.input.max*r,this.config.handle.max),this.setValue(this.limit(q)))},o.prototype.getValue=function(){return this.double?this.input.values:this.input.value},o.prototype.parseValue=function(p){var q=parseFloat(this.input.min),r=parseFloat(this.input.max);return void 0===p&&(p=this.input.value),p=parseFloat(p),p=p.toFixed(this.accuracy),p<q?p=q.toFixed(this.accuracy):p>r&&(p=r.toFixed(this.accuracy)),p},o.prototype.setValue=function(p,q){var r=this.nodes;if(p=this.parseValue(p),this.double&&void 0===q)return!1;var s=this.initialised&&(p!==this.input.value||this.nativeEvent);if(this.double){var t=this.input.values;if(t[q]=p,this.config.tooltips){r.tooltip[q].textContent=p;var u=r.tooltip[0].getBoundingClientRect(),v=r.tooltip[1].getBoundingClientRect();u=!(u.right<v.left||u.left>v.right||u.bottom<v.top||u.top>v.bottom),r.container.classList.toggle("combined-tooltip",u),u&&(r.tooltip[2].textContent=t[0]===t[1]?t[0]:t[0]+" - "+t[1])}}else this.input.value=p,r.tooltip.textContent=p;this.setPosition(p,q),s&&(this.onChange(),this.nativeEvent||this.input.dispatchEvent(new Event("input")),this.nativeEvent=!1)},o.prototype.native=function(){this.nativeEvent=!0,this.setValue()},o.prototype.setPosition=function(p){if(this.double){p=this.getPosition(this.input.values[0]);var q=this.getPosition(this.input.values[1]);this.nodes.progress.style[this.config.vertical?"bottom":"left"]=p+"px",p=q-p}else p=this.getPosition();this.nodes.progress.style[this.trackSize[this.axis]]=p+"px"},o.prototype.getPosition=function(p){void 0===p&&(p=this.input.value);var q=parseFloat(this.input.min),r=parseFloat(this.input.max);return(p-q)/(r-q)*this.rects.container[this.trackSize[this.axis]]},o.prototype.getHandle=function(p){if(!this.double)return!this.nodes.handle.locked&&this.nodes.handle;var q=this.rects,r=Math.abs(p[this.mouseAxis[this.axis]]-q.handle[0][this.trackPos[this.axis]]);return q=Math.abs(p[this.mouseAxis[this.axis]]-q.handle[1][this.trackPos[this.axis]]),(p=p.target.closest("."+this.config.classes.handle))||(p=r>q?this.nodes.handle[1]:this.nodes.handle[0]),!p.locked&&p},o.prototype.onInit=function(){j(this.config.onInit)&&this.config.onInit.call(this,this.getValue())},o.prototype.onStart=function(){j(this.config.onStart)&&this.config.onStart.call(this,this.getValue())},o.prototype.onChange=function(){j(this.config.onChange)&&this.config.onChange.call(this,this.getValue())},o.prototype.onEnd=function(){j(this.config.onEnd)&&this.config.onEnd.call(this,this.getValue())},o.prototype.enable=function(){this.disabled&&(this.touch?this.nodes.container.addEventListener("touchstart",this.events.touchstart):this.nodes.container.addEventListener("mousedown",this.events.down),this.nodes.container.classList.remove(this.config.classes.disabled),this.disabled=!1)},o.prototype.disable=function(){this.disabled||(this.touch?this.nodes.container.removeEventListener("touchstart",this.events.touchstart):this.nodes.container.removeEventListener("mousedown",this.events.down),this.nodes.container.classList.add(this.config.classes.disabled),this.disabled=!0)},o.prototype.bind=function(){this.events={start:this.start.bind(this),move:this.move.bind(this),stop:this.stop.bind(this),update:this.update.bind(this),reset:this.reset.bind(this),set:this.native.bind(this),key:this.keydown.bind(this)},this.events.scroll=n(this.events.update,this.config.updateThrottle),this.events.resize=n(this.events.update,this.config.updateThrottle),document.addEventListener("scroll",this.events.scroll,!1),window.addEventListener("resize",this.events.resize,!1),document.addEventListener("keydown",this.events.key,!1),this.nodes.container.addEventListener(this.touch?"touchstart":"mousedown",this.events.start,!1),this.input.addEventListener("input",this.events.set,!1),this.input.form&&this.input.form.addEventListener("reset",this.events.reset,!1)},o.prototype.unbind=function(){document.removeEventListener("scroll",this.events.scroll),window.removeEventListener("resize",this.events.resize),document.removeEventListener("keydown",this.events.key),this.nodes.container.removeEventListener(this.touch?"touchstart":"mousedown",void 0),this.input.removeEventListener("input",this.events.set),this.input.form&&this.input.form.removeEventListener("reset",this.events.reset),this.events=null},o.prototype.destroy=function(){this.input.rangeable&&(this.unbind(),this.input.classList.remove(this.config.classes.input),this.nodes.container.parentNode.replaceChild(this.input,this.nodes.container),delete this.input.rangeable,this.initialised=!1)},o});